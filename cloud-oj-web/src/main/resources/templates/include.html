<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="common_head(title, links, scripts, styles)">
    <meta charset="UTF-8">
    <title th:replace="${title}"></title>
    <link rel="shortcut icon" th:href="@{/favicon.ico}"/>
    <link rel="bookmark" th:href="@{/favicon.ico}"/>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/include.css">
    <script src="./js/common.js"></script>
    <script src="https://js-res.oss-cn-beijing.aliyuncs.com/layui/layui.all.js"></script>
    <script>
        !window.layui === undefined && document.write('<script src="./layui/layui.all.js"><\/script>');
    </script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
        !window.jQuery === undefined && document.write('<script src="./js/jquery-3.4.1.js"><\/script>');
    </script>
    <script src="./js/jquery.cookie.js"></script>
    <script src="./js/jquery.md5.js"></script>
    <th:block th:replace="${scripts}"/>
    <th:block th:replace="${styles}"/>
    <th:block th:replace="${links}"/>
    <script>
        let baseUrl = '[[${gateway_host}]]';
        let user = {
            userId: '',
            name: '',
            section: '',
            email: '',
            roleId: null,
            token: null,
            expire: null
        };
        let layer;
        $(document).ready(() => {
                layui.use('layer', () => {
                    layer = layui.layer;
                });

                let userInfo = $.cookie('cloudOjToken');
                if (userInfo != null) {
                    user = JSON.parse(userInfo);
                    if (new Date(Date.parse(user.expire)) <= new Date()) {
                        layer.open({
                            content: '你的登录已经过期，请重新登录！',
                            yes: () => {
                                clearToken();
                            },
                            cancel: () => {
                                clearToken();
                            }
                        });
                    }

                    $('#user-name').text(user.name);
                    $('#nav-commit').show();
                    if (user.roleId > 0) {
                        if (user.roleId === 1) {
                            $('#problem_manager').hide();
                            $('#contest_manager').hide();
                        } else if (user.roleId === 2) {
                            $('#user_manager').hide();
                        }
                        $('#nav-manager').show();
                    }
                    $('#poster').text(poster_login);
                } else {
                    $('#user').attr('href', 'javascript:start()');
                    $('#user-menu').removeClass('layui-nav-child');
                }
            }
        );

        function exit() {
            layer.confirm('确定退出吗？', {icon: 3, title: '提示'}, (index) => {
                logout();
                layer.close(index);
            });
        }

        function logout() {
            $.ajax({
                url: baseUrl + '/logoff?userId=' + user.userId,
                method: 'delete',
                headers: {
                    "token": user.token
                },
                success: (data) => {
                    clearToken();
                    layer.msg(data, {icon: 6});
                },
                error: (xhr) => {
                    if (xhr.status === 401)
                        clearToken();
                    layer.msg('请求错误，已退出！', {icon: 5});
                }
            });
        }

        function clearToken() {
            user = null;
            $.removeCookie('cloudOjToken');
            $('#user-name').text('未登录');
            $('#poster').text(poster);
            window.location.href = './index';
        }

        function start() {
            try {
                startCodding();
            } catch (e) {
                window.location.href = './index?login=true';
            }
        }
    </script>
</head>
<body>
<div id="nav" th:fragment="top" class="layui-header header">
    <div class="layui-main">
        <div class="logo">
            <a id="oj-name" href="./index">Cloud OJ</a>
        </div>
        <ul class="layui-nav layui-layout-left">
            <li id="nav-problems" class="layui-nav-item">
                <a class="menu-text" href="./problems">题目列表</a>
            </li>
            <li id="nav-contests" class="layui-nav-item">
                <a class="menu-text" href="./contests">竞赛/作业</a>
            </li>
            <li id="nav-commit" class="layui-nav-item" style="display: none">
                <a class="menu-text" href="./results">提交记录</a>
            </li>
            <li id="nav-ranking" class="layui-nav-item">
                <a class="menu-text" href="./ranking">排行榜</a>
            </li>
            <li id="nav-manager" class="layui-nav-item" style="display: none">
                <a class="menu-text" style="cursor: pointer">管 理</a>
                <dl class="layui-nav-child">
                    <dd id="user_manager"><a
                            href="javascript:window.location.href='./manager_user?userId=' + user.userId + '&token=' + user.token">用户管理</a>
                    </dd>
                    <dd id="problem_manager"><a
                            href="javascript:window.location.href='./manager_problem?userId=' +user.userId + '&token=' + user.token">题目管理</a>
                    </dd>
                    <dd id="contest_manager"><a
                            href="javascript:window.location.href='./manager_contest?userId=' +user.userId + '&token=' + user.token">竞赛/作业管理</a>
                    </dd>
                </dl>
            </li>
            <li id="nav-help" class="layui-nav-item">
                <a class="menu-text" href="./help">帮 助</a>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a id="user" style="cursor: pointer;"><span id="user-name">未登录</span></a>
                <dl id="user-menu" class="layui-nav-child" style="display: none">
                    <dd style="display: none" id="info"><a href="#">基本资料</a></dd>
                    <dd id="exit"><a href="javascript:exit()">退了</a></dd>
                </dl>
            </li>
        </ul>
    </div>
</div>
<div id="foot" th:fragment="foot" style="color: #666666; text-align: center; margin: 50px 0 30px 0;">
    <div class="layui-container">
        <hr style="margin: 0 auto 20px auto;">
        © 2020
        <p style="display: inline-block; padding: 0 5px; color: #333333">Cloud Li</p>
        MIT License
        <p style="padding: 0 5px; display: inline-block">
            <a href="https://github.com/imcloudfloating/Cloud-OJ-Docker" target="_blank">GitHub</a>
        </p>
        <p style="padding: 6px 0; color: #999999">Based on</p>
        <div style="display: inline-flex; align-items: center; text-align: center;">
            <img class="framework-logo" alt="Layui" src="./img/logo/layui.png">
            <a class="framework-link" href="https://www.layui.com/" target="_blank"
               style="color: #3b3d49"><b>Layui</b></a>
            <img class="framework-logo" style="margin-left: 12px;" alt="Spring Cloud"
                 src="./img/logo/spring-cloud.png">
            <a class="framework-link" href="https://spring.io/projects/spring-cloud/" target="_blank"
               style="color: #75b240">
                <b>Spring Cloud</b>
            </a>
            <img class="framework-logo" style="margin-left: 12px;" alt="Docker"
                 src="./img/logo/docker.png">
            <a class="framework-link" href="https://www.docker.com/" target="_blank"
               style="color: #4196eb">
                <b>Docker</b>
            </a>
        </div>
    </div>
</div>
</body>
</html>