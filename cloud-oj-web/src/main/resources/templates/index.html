<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include::common_head(~{::title}, ~{}, ~{}, ~{::style})">
    <meta charset="UTF-8">
    <title>主页</title>
    <style>
        html {
            height: 100%;
        }

        .container {
            border-top: 1px solid #404553;
            height: calc(100% - 61px);
            min-height: 800px;
            background-image: url('img/background.jpg');
            background-position: center top;
            background-size: cover;
            background-repeat: no-repeat;
        }

        .title-text {
            margin-top: 20%;
            text-align: center;
            width: 100%;
            color: white;
            transition: margin-top 500ms;
        }

        #login-pane {
            margin: 30px auto;
            width: 450px;
            background: white;
            display: none;
        }
    </style>
</head>
<body>
<div th:replace="include::top"></div>
<div class="container">
    <div id="title-text" class="title-text">
        <h2 style="font-size: 32pt"><b>TALK IS CHEAP, SHOW ME YOUR CODE!</b></h2>
        <button id="start-btn" class="layui-btn layui-btn-lg layui-btn-radius layui-btn-normal"
                style="margin-top: 24px"
                onclick="startCodding()">
        </button>
    </div>

    <div id="login-pane">
        <div class="layui-collapse" lay-accordion>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">登 录</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <label for="userId" class="layui-form-label">ID</label>
                            <div class="layui-input-block">
                                <input class="layui-input" lay-filter="userId" id="userId" type="text" name="userId"
                                       lay-verify="required"
                                       placeholder="输入ID（学号）">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="password" class="layui-form-label">密码</label>
                            <div class="layui-input-block">
                                <input class="layui-input" lay-filter="password" id="password" type="password"
                                       name="password" autocomplete="new-password"
                                       lay-verify="required"
                                       placeholder="输入密码">
                            </div>
                        </div>
                        <div class="layui-form-item" style="text-align: center">
                            <button lay-submit lay-filter="login" id="login"
                                    class="layui-btn layui-btn-lg layui-btn-radius layui-btn-normal"
                                    style="width: 70%; margin: 0 auto">登 录
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">注 册</h2>
                <div class="layui-colla-content">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <label for="reg-userId" class="layui-form-label">ID</label>
                            <div class="layui-input-block">
                                <input class="layui-input" id="reg-userId" name="userId" lay-verify="required"
                                       placeholder="输入ID（学号）">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="reg-name" class="layui-form-label">昵称</label>
                            <div class="layui-input-block">
                                <input class="layui-input" id="reg-name" name="name" lay-verify="required"
                                       placeholder="输入昵称">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="reg-password" class="layui-form-label">密码</label>
                            <div class="layui-input-block">
                                <input class="layui-input" id="reg-password" type="password" name="password"
                                       lay-verify="required" autocomplete="new-password"
                                       placeholder="输入密码">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="reg-email" class="layui-form-label">邮箱</label>
                            <div class="layui-input-block">
                                <input class="layui-input" id="reg-email" type="email" name="email"
                                       lay-verify="required | email" placeholder="你的邮箱">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="reg-school" class="layui-form-label">学校/班级</label>
                            <div class="layui-input-block">
                                <input class="layui-input" id="reg-school" type="text" name="section"
                                       lay-verify="required" placeholder="你的学校/班级">
                            </div>
                        </div>
                        <div class="layui-form-item" style="text-align: center">
                            <button lay-submit lay-filter="register" class="layui-btn layui-btn-radius layui-btn-lg"
                                    style="width: 70%; margin: 0 auto;">注册
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let $startBtn = $('#start-btn');

    $(document).ready(() => {
        $startBtn.text(user.token === null ? '登录去练习' : '去练习');
        if (getQueryVariable('login') === 'true') {
            setTimeout(() => {
                startCodding()
            }, 500);
        }
    });

    layui.use(['form', 'element', 'carousel', 'layer'], function () {
        let form = layui.form;
        form.render();

        let element = layui.element;
        element.init();

        let layer = layui.layer;

        let carousel = layui.carousel;

        carousel.render({
            elem: '#pic',
            width: '100%',
            height: '100%',
            anim: 'fade'
        });

        let loadIndex;
        // Login
        form.on('submit(login)', (data) => {
            let login = data.field;

            $.ajax({
                url: baseUrl + '/login',
                method: 'post',
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                data: {
                    username: login.userId,
                    password: $.md5(login.password)
                },
                beforeSend: () => {
                    loadIndex = layer.load(1);
                },
                success: (data) => {
                    layer.close(loadIndex);
                    user = data;
                    $('#user-name').text(user.name);
                    $.cookie('cloudOjToken', JSON.stringify(user));
                    window.location.href = './problems';
                },
                error: (xhr) => {
                    layer.close(loadIndex);
                    layer.open({
                        content: xhr.status === 400 ? '用户名或密码错误！' : '出现了错误！'
                    });
                }
            });
        });

        // Register
        form.on('submit(register)', (data) => {
            let register = data.field;
            register.password = $.md5(register.password);
            $.ajax({
                url: baseUrl + '/api/manager/user',
                method: "post",
                headers: {
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(register),
                beforeSend: () => {
                    loadIndex = layer.load(1);
                },
                success: () => {
                    layer.close(loadIndex);
                    layer.open({
                        content: '注册成功'
                    });
                },
                error: (xhr) => {
                    layer.close(loadIndex);
                    layer.open({
                        content: xhr.status === 400 ? '用户已存在！' : xhr.status + ': 发生了错误！'
                    });
                }
            });
        });
    });

    function startCodding() {
        if (user.token !== null) {
            window.location.href = './problems';
        } else {
            $startBtn.hide();
            $('#title-text').css('margin-top', '10%');
            $('#login-pane').show(500);
        }
    }

    $('#password').keydown((e) => {
        if (e.keyCode === 13)
            $('#login').trigger('click');
    });
</script>
</body>
</html>