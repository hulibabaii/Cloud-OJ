<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include::common_head(~{::title}, ~{}, ~{}, ~{})">
    <meta charset="UTF-8">
    <title>题目列表</title>
</head>
<body>
<div th:replace="include::top"></div>
<div class="layui-container">
    <!-- 题目列表 -->
    <table id="problems">

    </table>
</div>
<div th:replace="include::foot"></div>
<script type="text/html" id="titleTpl">
    {{# if (d.contestId !== undefined) { }}
    <a href="./commit?problemId={{d.problemId}}&contestId={{d.contestId}}" class="layui-table-link"><b>{{d.title}}</b></a>
    {{# } else { }}
    <a href="./commit?problemId={{d.problemId}}" class="layui-table-link"><b>{{d.title}}</b></a>
    {{# } }}
</script>
<script type="text/html" id="categoryTpl">
    {{# if (d.contestName === undefined && d.category != undefined) { }}
    {{# layui.each(d.category.split(','), (index, item) => { }}
    <span class="category {{getColor(item)}}" onclick="addTag(this.innerHTML)">{{ item }}</span>
    {{# }); }}
    {{# } else if (d.contestName != undefined) { }}
    <span class="label bg-blue">{{ d.contestName }}</span>
    {{# } }}
</script>
<script type="text/html" id="resultTpl">
    {{# if (d.result == 0) { }}
    <span class="bg-green label">通过</span>
    {{# } else if (d.result == 1) { }}
    <span class="bg-yellow label">超时</span>
    {{# } else if (d.result == 2) { }}
    <span class="bg-yellow label">部分通过</span>
    {{# } else if (d.result == 3) { }}
    <span class="bg-red label">答案错误</span>
    {{# } else if (d.result == 4) { }}
    <span class="bg-grey label">编译错误</span>
    {{# } }}
</script>
<script type="text/html" id="top-bar">
    {{# if (getQueryVariable('contestId') == null) { }}
    <div class="layui-form-item" style="margin-bottom: 0; display: inline-block">
        <div class="layui-input-inline">
            <input id="keyword" class="layui-input" placeholder="输入题目名称" type="text" autocomplete="off"
                   onkeydown="onSearch(event)">
        </div>
        <button class="layui-btn layui-icon layui-icon-search" onclick="search($('#keyword').val())">&nbsp;&nbsp;搜索
        </button>
    </div>
    <div id="tag" style="float: right; display: inline-block">

    </div>
    {{# } else { }}
    <label id="contest_name" style="color: #5FB878; font-size: 14pt; font-weight: bold"></label>
    {{# } }}
</script>
<script>
    let problemsTable;
    $(document).ready(() => {
        let contestId = getQueryVariable('contestId');

        if (contestId != null) {
            $('#search-box').hide();
            $('#nav-contests').addClass("layui-this");
        } else {
            $('#nav-problems').addClass("layui-this");
        }

        let apiUrl = contestId == null ?
            baseUrl + '/api/manager/problem' :
            baseUrl + '/api/manager/contest/' + contestId;

        if (user.userId != null) apiUrl += '?userId=' + user.userId;

        layui.use(['table', 'element'], () => {
            let element = layui.element;
            element.init();
            let table = layui.table;

            problemsTable = table.render({
                elem: '#problems',
                url: apiUrl,
                parseData: (res) => {
                    if (res !== undefined && res.count > 0 && res.data[0].contestName !== undefined)
                        $('#contest_name').text(res.data[0].contestName);
                    return {
                        "code": 0,
                        "count": res === undefined ? 0 : res.count,
                        "data": res === undefined ? null : res.data
                    }
                },
                skin: 'nob',
                size: 'lg',
                even: true,
                page: true,
                limit: 15,
                limits: [10, 15, 20, 25, 30],
                defaultToolbar: [],
                toolbar: '#top-bar',
                cols: [
                    [
                        {field: 'problemId', title: '编号', width: '10%', align: 'center'},
                        {field: 'title', title: '题目名称', width: '25%', templet: '#titleTpl'},
                        {field: 'result', title: '状态', width: '15%', align: 'center', templet: '#resultTpl'},
                        {field: 'category', title: '标签/分类', width: '40%', align: 'center', templet: '#categoryTpl'},
                        {field: 'createAt', title: '创建时间', width: '10%'}
                    ]
                ]
            });
        });
    });

    function onSearch(e) {
        if (e.keyCode === 13)
            search($('#keyword').val().trim());
    }

    function search(keyword) {
        problemsTable.reload({
            where: {
                keyword: keyword.trim()
            }
        });
    }

    function addTag(text) {
        search(text);
        let tag = $('<span class="tag">' + text + '</span>')
            .addClass(getColor(text))
            .append($('<span style="cursor: pointer">&nbsp;&nbsp;X</span>').on('click', clear));
        $('#tag').text('当前分类：')
            .append(tag);
    }

    function clear() {
        problemsTable.reload({
            where: {
                keyword: null
            }
        });
    }
</script>
</body>
</html>